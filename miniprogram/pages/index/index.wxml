<!--pages/index/index.wxml-->
<view class="container">
  <!-- é€‰æ‹©å™¨åŒºåŸŸ -->
  <view class="selectors-section">
    <view class="selectors-row">
      <!-- åŸå¸‚é€‰æ‹©å™¨ -->
      <view class="city-selector">
        <picker mode="selector" range="{{cities}}" range-key="name" bindchange="onCityChange">
          <view class="picker">
            <text class="label">åŸå¸‚</text>
            <text class="city-name">{{selectedCityName}}</text>
          </view>
        </picker>
      </view>

      <!-- æ˜¾ç¤ºæ¨¡å¼é€‰æ‹©å™¨ -->
      <view class="mode-selector">
        <picker mode="selector" range="{{displayModes}}" range-key="label" bindchange="onModeChange">
          <view class="picker">
            <text class="label">æ¨¡å¼</text>
            <text class="mode-label">{{displayModeLabel}}</text>
          </view>
        </picker>
      </view>
    </view>
  </view>

  <!-- æ¨¡å¼è¯´æ˜ + å›¾ä¾‹ -->
  <view class="mode-desc-card">
    <text class="mode-desc-text">{{modeDesc}}</text>
    <view class="legend-compact">
      <view class="legend-item">
        <view class="color-box up"></view>
        <text>çº¢æ¶¨</text>
      </view>
      <view class="legend-item">
        <view class="color-box down"></view>
        <text>ç»¿è·Œ</text>
      </view>
    </view>
  </view>

  <!-- åŠ è½½çŠ¶æ€ -->
  <view wx:if="{{loading}}" class="loading">
    <text>åŠ è½½ä¸­...</text>
  </view>

  <!-- é”™è¯¯æç¤º -->
  <view wx:if="{{errorMsg}}" class="error">
    <text>{{errorMsg}}</text>
  </view>

  <!-- Kçº¿å›¾å®¹å™¨ -->
  <view wx:if="{{!loading && !errorMsg && !showReportModal}}" class="chart-container">
    <kline-chart klineData="{{klineData}}" displayMode="{{displayMode}}"></kline-chart>
  </view>

  <!-- åŸºç¡€æ•°æ®ç»Ÿè®¡ -->
  <view wx:if="{{!loading && !errorMsg && klineData.length > 0}}" class="stats-card">
    <view class="stats-title">ğŸ“ˆ æ•°æ®ç»Ÿè®¡</view>
    <view class="stats-grid">
      <view class="stat-item">
        <text class="stat-value">{{stats.ups}}</text>
        <text class="stat-label">ä¸Šæ¶¨å‘¨æ•°</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{stats.downs}}</text>
        <text class="stat-label">ä¸‹è·Œå‘¨æ•°</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{stats.maxHigh}}</text>
        <text class="stat-label">æœ€é«˜ç‚¹</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{stats.minLow}}</text>
        <text class="stat-label">æœ€ä½ç‚¹</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{stats.avgChange}}</text>
        <text class="stat-label">å¹³å‡å˜åŒ–</text>
      </view>
      <view class="stat-item">
        <text class="stat-value">{{stats.totalWeeks}}</text>
        <text class="stat-label">æ€»å‘¨æ•°</text>
      </view>
    </view>
    <view class="stats-range">
      <text class="range-text">ğŸ“… æ—¶é—´èŒƒå›´ï¼š{{stats.dateRange}}</text>
    </view>
  </view>

  <!-- AIåˆ†ææŒ‰é’® -->
  <view wx:if="{{!loading && !errorMsg && klineData.length > 0}}" class="analyze-section">
    <button class="analyze-btn" bindtap="onGenerateReport" disabled="{{analyzing}}">
      <text wx:if="{{!analyzing}}">ğŸ”® AIåˆ†æ</text>
      <text wx:else="{{analyzing}}">ğŸ”® åˆ†æä¸­...</text>
    </button>
  </view>

  <!-- AIåˆ†ææŠ¥å‘Šå¼¹çª— -->
  <view wx:if="{{showReportModal}}" class="report-modal" bindtap="onCloseReport">
    <view class="report-modal-content" catchtap="onStopPropagation">
      <!-- å…³é—­æŒ‰é’® -->
    <view class="report-close-btn" bindtap="onCloseReport">
      <text>âœ•</text>
    </view>

      <view class="report-header">
        <text class="report-title">ğŸ“Š {{selectedCityName}}å¹´åº¦æ¸©åº¦Kçº¿åˆ†ææŠ¥å‘Š</text>
        <text class="report-mode">{{displayModeLabel}}æ¨¡å¼</text>
      </view>

      <!-- å…³é”®è¯æ ‡ç­¾ -->
      <view wx:if="{{reportKeywords.length > 0}}" class="keywords-section">
        <view class="keyword-tag" wx:for="{{reportKeywords}}" wx:key="index">
          <text>{{item}}</text>
        </view>
      </view>

      <view class="report-content">
        <text class="report-text">{{analysisReport}}</text>
      </view>
      <view class="report-footer">
        <text class="report-time">ç”Ÿæˆæ—¶é—´ï¼š{{reportTime}}</text>
      </view>
      <!-- åˆ†äº«æŒ‰é’® -->
      <view class="share-section">
        <button class="share-btn" bindtap="onShareReport" open-type="share">
          <text>ğŸ“± åˆ†äº«ç»™å¥½å‹</text>
        </button>
      </view>
    </view>
  </view>
</view>
