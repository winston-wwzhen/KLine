# AI报告关键词功能设计

## 📋 需求概述

在现有的AI分析报告基础上，额外生成一组关键词（Keywords），用于：
- 快速总结报告核心内容
- 便于用户快速浏览和理解
- 为后续功能提供数据支持（搜索、分类、话题标签）

## 🎯 设计目标

### 1. 关键词数量
- 每份报告生成 **3-5个** 关键词
- 关键词长度：**2-4个字**
- 格式：`["关键词1", "关键词2", "关键词3", ...]`

### 2. 关键词类型

#### A. 核心情感词
- 描述温度趋势的情感色彩
- 示例：`["温暖", "寒冷", "刺激", "温和", "极端"]`

#### B. 数据特征词
- 描述数据表现的典型特征
- 示例：`["温差大", "上涨多", "波动小", "平稳", "起伏"]`

#### C. 季节特点词
- 描述四季变化特点
- 示例：`["四季分明", "暖冬", "凉夏", "春秋短"]`

#### D. 体验词
- 描述人体感受
- 示例：`["宜居", "穿衣困难", "舒适", "多变"]`

#### E. 话题词
- 适合社交传播的话题标签
- 示例：`["避暑胜地", "避寒圣地", "温差挑战", "天气过山车"]`

## 🏗️ 技术实现方案

### 方案一：Prompt引导生成（推荐）

在现有 `analyze-kline` 云函数的 `systemPrompt` 中添加要求：

```javascript
const systemPrompt = `你是一位擅长在社交媒体上创作爆款内容的数据分析师和天气达人。

📋 **报告输出格式**：
1. 首先输出 **3-5个关键词**（用JSON数组格式）
2. 然后输出完整的分析报告

关键词要求：
- 每个关键词2-4个字
- 能准确概括该城市年度天气的核心特点
- 包含：情感色彩、数据特征、季节特点、人体感受、话题标签
- 适合作为搜索和分类标签

输出示例：
["温差大", "四季分明", "穿衣困难", "天气过山车"]

--- 正文开始 ---

【吸睛标题】...
`;

const userContent = `请生成以下数据的分析报告：

📍 城市：${dataSummary.city}
📊 数据模式：${mode}
...

请先输出3-5个关键词，然后生成完整的分析报告。`;
```

### 方案二：单独生成关键词

创建独立的prompt专门生成关键词：

```javascript
const keywordPrompt = `请根据以下温度K线数据，生成3-5个关键词：

城市：${cityName}
模式：${mode}
核心数据：
- 上涨周数：${ups}周
- 下跌周数：${downs}周
- 平均变化：${avgChange}
- 极差：${maxHigh - minLow}

要求：
1. 2-4个字
2. 概括核心特点
3. 适合作为标签

直接返回JSON数组，不要其他内容。`;
```

### 数据库存储

在 `kline_analysis` 集合中添加 `keywords` 字段：

```javascript
{
  _id: ObjectId,
  city: 'Beijing',
  cityName: '北京',
  mode: 'original',
  report: '...',           // AI生成的完整报告
  keywords: ["温差大", "四季分明", "穿衣困难"],  // 新增：关键词数组
  createTime: ISODate,
  updateTime: ISODate
}
```

## 📊 不同模式的关键词侧重点

### 1. 原始温度模式
侧重：真实体感、生活场景
- 示例：`["寒冷", "四季分明", "穿衣困难"]`

### 2. Z-score标准化模式
侧重：异常程度、极端天气
- 示例：`["异常多", "极端天气", "气候波动"]`

### 3. 环比变化率模式
侧重：变化节奏、起伏特征
- 示例：`["起伏大", "突变频繁", "节奏快"]`

### 4. 昼夜温差模式
侧重：一日体验、穿衣建议
- 示例：`["温差刺激", "早晚穿啥", "一日四季"]`

### 5. 累积距平模式
侧重：长期趋势、气候异常
- 示例：`["偏暖", "持续升温", "气候异常"]`

### 6. 温度加速度模式
侧重：变化加速度、转折点
- 示例：`["急转", "换季快", "过山车"]`

## 🎨 前端展示方案

### 方案A：卡片顶部展示
```
┌─────────────────────────────────┐
│ ["温差大"] ["四季分明"] ["穿衣困难"] │  ← 关键词标签
├─────────────────────────────────┤
│ 📊 北京年度温度K线分析报告       │
│ 原始温度模式                     │
│                                 │
│ 【北京的一年，温差能折磨死你】   │
│ ...                             │
└─────────────────────────────────┘
```

### 方案B：标签云样式
```css
.keyword-tags {
  display: flex;
  flex-wrap: wrap;
  gap: 12rpx;
  margin-bottom: 20rpx;
}

.keyword-tag {
  background: linear-gradient(135deg, rgba(102, 126, 234, 0.3) 0%, rgba(118, 75, 162, 0.3) 100%);
  border: 1rpx solid rgba(102, 126, 234, 0.5);
  border-radius: 12rpx;
  padding: 8rpx 20rpx;
  font-size: 24rpx;
  color: rgba(255, 255, 255, 0.9);
}
```

## 🚀 实施步骤

1. **修改AI Prompt**（在 analyze-kline/index.js）
   - 在 systemPrompt 中添加关键词生成要求
   - 指定输出格式（JSON数组）

2. **解析关键词**（在 analyze-kline/index.js）
   - 从AI返回结果中提取关键词部分
   - JSON.parse() 解析为数组

3. **数据库存储**（在 analyze-kline/index.js）
   - 在保存记录时添加 keywords 字段

4. **前端展示**（在 pages/index/index.*）
   - 在报告卡片顶部添加关键词标签展示
   - 添加对应的样式

5. **管理后台展示**（在 pages/admin/admin.*）
   - 在列表中展示关键词
   - 支持按关键词搜索和筛选

## 📈 后续功能扩展

### 1. 关键词聚合分析
```javascript
// 统计所有报告的关键词分布
{
  "温差大": 15,    // 15个城市的关键词包含"温差大"
  "四季分明": 20,
  "穿衣困难": 8
}
```

### 2. 关键词推荐
- 根据用户查看的城市，推荐关键词相似的城市
- "你可能还喜欢：温差同样刺激的城市"

### 3. 话题聚合页
```javascript
// 点击关键词查看所有相关报告
onClick(keyword) {
  wx.navigateTo({
    url: `/pages/keyword/index?keyword=${keyword}`
  });
}
```

### 4. 海报生成
- 将关键词作为海报的标签元素
- 自动布局到海报的合适位置

### 5. 社交分享优化
```javascript
// 分享时自动带上关键词标签
onShareAppMessage() {
  return {
    title: `${keywords.join(" ")} - ${cityName}年度天气`,
    path: `/pages/index/index?city=${city}`
  };
}
```

## ✅ 验收标准

- [x] AI生成的关键词准确概括报告内容
- [x] 关键词格式正确（JSON数组）
- [x] 前端正确展示关键词标签
- [x] 数据库正确存储关键词
- [ ] 不同模式的关键词有明显区分（待批量生成完成后验证）
- [x] 关键词长度在2-4字之间
- [x] 报告长度精简至300-400字
- [x] 明确使用"2025年"而非"今年"

---

**文档版本**: v1.1
**创建时间**: 2025-01-06
**更新时间**: 2025-01-06
**状态**: ✅ 已实施
**实施内容**:
- ✅ 云函数已添加关键词生成和解析逻辑
- ✅ 数据库已添加 keywords 字段
- ✅ 前端报告卡片已添加关键词标签展示
- ✅ 管理后台列表已添加关键词展示
- ✅ 优化prompt：报告长度从600-800字缩短至300-400字
- ✅ 明确要求使用"2025年"而非"今年"

**待验证**: 批量生成任务完成后，检查不同模式的关键词区分度

